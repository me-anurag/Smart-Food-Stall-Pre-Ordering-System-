{% extends "base.html" %}

{% block content %}

<h3 class="mb-4">Shopkeeper Dashboard</h3>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow text-center">
            <div class="card-body">
                <h6>Today's Revenue</h6>
                <h4 id="todayRevenue">₹{{ revenue }}</h4>
            </div>
        </div>
    </div>
</div>

<h5>Active Orders</h5>

<table class="table table-bordered align-middle">
    <thead class="table-dark">
        <tr>
            <th>Food</th>
            <th>User</th>
            <th>Qty</th>
            <th>Time</th>
            <th>Paid</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="ordersTable">
        {% for order in active_orders %}
        <tr id="order-{{ order.id }}">
            <td>
                <div class="d-flex align-items-center">
                    {% if order.image %}
                    <img src="{{ url_for('static', filename='images/' + order.image) }}"
                         width="60"
                         height="60"
                         class="rounded me-2"
                         style="object-fit:cover;">
                    {% endif %}
                    <strong>{{ order.item_name }}</strong>
                </div>
            </td>

            <td>{{ order.user_name }}</td>
            <td>{{ order.quantity }}</td>
            <td>{{ order.time_slot }}</td>

            <td>
                <span class="badge bg-success">
                    {{ order.payment_status }}
                </span>
            </td>

            <td class="status">
                <span class="badge 
                    {% if order.status == 'Pending' %}bg-secondary
                    {% elif order.status == 'Preparing' %}bg-warning text-dark
                    {% elif order.status == 'Ready' %}bg-primary
                    {% elif order.status == 'Completed' %}bg-dark
                    {% endif %}">
                    {{ order.status }}
                </span>
            </td>

            <td>
                <button class="btn btn-sm btn-warning"
                        onclick="updateStatus({{ order.id }}, 'Preparing')">
                        Preparing
                </button>
                <button class="btn btn-sm btn-success"
                        onclick="updateStatus({{ order.id }}, 'Ready')">
                        Ready
                </button>
                <button class="btn btn-sm btn-dark"
                        onclick="updateStatus({{ order.id }}, 'Completed')">
                        Complete
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h5 class="mt-5">Completed Orders</h5>

<table class="table table-bordered align-middle">
    <thead class="table-secondary">
        <tr>
            <th>Food</th>
            <th>User</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody id="completedTable">
        {% for order in completed_orders %}
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    {% if order.image %}
                    <img src="{{ url_for('static', filename='images/' + order.image) }}"
                         width="50"
                         height="50"
                         class="rounded me-2"
                         style="object-fit:cover;">
                    {% endif %}
                    {{ order.item_name }}
                </div>
            </td>
            <td>{{ order.user_name }}</td>
            <td>₹{{ order.total_price }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
var socket = io();

socket.on("new_order", function(data) {

    var table = document.getElementById("ordersTable");

    var row = `
        <tr id="order-${data.id}">
            <td>
                <div class="d-flex align-items-center">
                    <img src="/static/images/${data.image}"
                         width="60"
                         height="60"
                         class="rounded me-2"
                         style="object-fit:cover;">
                    <strong>${data.item_name}</strong>
                </div>
            </td>
            <td>${data.user_name}</td>
            <td>${data.quantity}</td>
            <td>${data.time_slot}</td>
            <td><span class="badge bg-success">${data.payment_status}</span></td>
            <td class="status">
                <span class="badge bg-secondary">${data.status}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-warning"
                        onclick="updateStatus(${data.id}, 'Preparing')">
                        Preparing
                </button>
                <button class="btn btn-sm btn-success"
                        onclick="updateStatus(${data.id}, 'Ready')">
                        Ready
                </button>
                <button class="btn btn-sm btn-dark"
                        onclick="updateStatus(${data.id}, 'Completed')">
                        Complete
                </button>
            </td>
        </tr>
    `;

    table.insertAdjacentHTML("afterbegin", row);
});

socket.on("status_updated", function(data) {
    var row = document.getElementById("order-" + data.id);

    if (row) {
        var badge = row.querySelector(".status span");
        badge.innerText = data.status;

        badge.className = "badge";

        if (data.status === "Preparing") {
            badge.classList.add("bg-warning", "text-dark");
        } else if (data.status === "Ready") {
            badge.classList.add("bg-primary");
        } else if (data.status === "Completed") {
            badge.classList.add("bg-dark");
            row.remove();
        } else {
            badge.classList.add("bg-secondary");
        }
    }
});

function updateStatus(orderId, status) {
    fetch("/update-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: orderId, status: status })
    });
}
</script>

{% endblock %}